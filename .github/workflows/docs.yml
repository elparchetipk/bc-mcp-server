name: ğŸ“š Documentation Build & Deploy

# Este workflow genera y despliega la documentaciÃ³n automÃ¡ticamente
# Se ejecuta cuando hay cambios en docs/ o en push a main
on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/docs.yml'
  pull_request:
    paths:
      - 'docs/**'
      - 'README.md'

# Permisos para escribir en GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Solo permitir un deployment concurrente
concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  # 1. Validar estructura de documentaciÃ³n
  validate-docs:
    name: ğŸ” Validar DocumentaciÃ³n
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“¥ Instalar dependencias de docs
        run: |
          if [ -f "docs/package.json" ]; then
            cd docs
            pnpm install
            cd ..
          fi

      - name: ğŸ” Verificar enlaces rotos
        run: |
          # Instalar herramienta para verificar enlaces
          pnpm add -g markdown-link-check

          # Verificar enlaces en README principal
          markdown-link-check README.md --config .github/markdown-link-check.json || true

          # Verificar enlaces en documentaciÃ³n
          find docs -name "*.md" -exec markdown-link-check {} --config .github/markdown-link-check.json \; || true

      - name: ğŸ“‹ Validar estructura de mÃ³dulos
        run: |
          echo "Validando estructura de mÃ³dulos..."

          # Verificar que cada mÃ³dulo tenga su README
          for modulo in docs/modulos/modulo-*/; do
            if [ -d "$modulo" ]; then
              if [ ! -f "$modulo/README.md" ]; then
                echo "âŒ Falta README.md en $modulo"
                exit 1
              else
                echo "âœ… $modulo tiene README.md"
              fi
            fi
          done

      - name: ğŸ¯ Validar rÃºbricas de evaluaciÃ³n
        run: |
          echo "Validando rÃºbricas..."

          # Verificar que cada mÃ³dulo tenga su rÃºbrica
          for i in {01..07}; do
            rubrica="docs/evaluaciones/rubricas/modulo-${i}.md"
            if [ ! -f "$rubrica" ]; then
              echo "âš ï¸  Falta rÃºbrica: $rubrica"
            else
              echo "âœ… RÃºbrica encontrada: $rubrica"
            fi
          done

  # 2. Generar documentaciÃ³n estÃ¡tica
  build-docs:
    name: ğŸ—ï¸ Construir DocumentaciÃ³n
    runs-on: ubuntu-latest
    needs: validate-docs

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ—ï¸ Construir sitio de documentaciÃ³n
        run: |
          # Crear directorio de build
          mkdir -p _site

          # Copiar archivos principales
          cp README.md _site/index.md
          cp -r docs/* _site/

          # Copiar assets
          if [ -d "docs/assets" ]; then
            cp -r docs/assets _site/
          fi

          # Generar Ã­ndice de contenidos
          echo "# ğŸ“š DocumentaciÃ³n del MCP Server Bootcamp" > _site/README.md
          echo "" >> _site/README.md
          echo "Bienvenido a la documentaciÃ³n completa del bootcamp." >> _site/README.md
          echo "" >> _site/README.md

          # Crear configuraciÃ³n para GitHub Pages
          echo "theme: minima" > _site/_config.yml
          echo "title: MCP Server Bootcamp" >> _site/_config.yml
          echo "description: Bootcamp completo para dominar servidores MCP" >> _site/_config.yml

      - name: ğŸ“¤ Subir artefacto de documentaciÃ³n
        uses: actions/upload-pages-artifact@v2
        with:
          path: '_site'

  # 3. Generar mÃ©tricas de documentaciÃ³n
  docs-metrics:
    name: ğŸ“Š MÃ©tricas de DocumentaciÃ³n
    runs-on: ubuntu-latest
    needs: validate-docs

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“Š Generar estadÃ­sticas
        run: |
          echo "## ğŸ“Š MÃ©tricas de DocumentaciÃ³n" > docs-metrics.md
          echo "" >> docs-metrics.md

          # Contar archivos de documentaciÃ³n
          total_docs=$(find docs -name "*.md" | wc -l)
          echo "- **Total de archivos de documentaciÃ³n**: $total_docs" >> docs-metrics.md

          # Contar palabras en documentaciÃ³n
          total_words=$(find docs -name "*.md" -exec wc -w {} \; | awk '{sum += $1} END {print sum}')
          echo "- **Total de palabras**: $total_words" >> docs-metrics.md

          # Listar mÃ³dulos
          echo "- **MÃ³dulos disponibles**:" >> docs-metrics.md
          for modulo in docs/modulos/modulo-*/; do
            if [ -d "$modulo" ]; then
              modulo_name=$(basename "$modulo")
              echo "  - $modulo_name" >> docs-metrics.md
            fi
          done

          # Verificar ejemplos
          echo "- **Ejemplos por mÃ³dulo**:" >> docs-metrics.md
          for i in {01..07}; do
            ejemplos=$(find ejemplos/modulo-${i} -name "package.json" 2>/dev/null | wc -l)
            echo "  - MÃ³dulo ${i}: $ejemplos ejemplos" >> docs-metrics.md
          done

          cat docs-metrics.md

      - name: ğŸ“¤ Guardar mÃ©tricas como artefacto
        uses: actions/upload-artifact@v3
        with:
          name: docs-metrics
          path: docs-metrics.md

  # 4. Deploy a GitHub Pages (solo en main)
  deploy:
    name: ğŸš€ Deploy a GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸš€ Deploy a GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

  # 5. Comentar en PR con vista previa
  preview-comment:
    name: ğŸ’¬ Comentario de Vista Previa
    runs-on: ubuntu-latest
    needs: [validate-docs, docs-metrics]
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Descargar mÃ©tricas
        uses: actions/download-artifact@v3
        with:
          name: docs-metrics

      - name: ğŸ’¬ Comentar en PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metrics = fs.readFileSync('docs-metrics.md', 'utf8');

            const comment = `## ğŸ“š Vista Previa de DocumentaciÃ³n

            Â¡Gracias por contribuir a la documentaciÃ³n del bootcamp! ğŸ‰

            ${metrics}

            ### âœ… Checks Realizados
            - ğŸ” ValidaciÃ³n de enlaces
            - ğŸ“‹ Estructura de mÃ³dulos  
            - ğŸ¯ RÃºbricas de evaluaciÃ³n
            - ğŸ“Š MÃ©tricas de contenido

            La documentaciÃ³n se desplegarÃ¡ automÃ¡ticamente cuando se haga merge a \`main\`.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
