name: ğŸ”„ Dependency Updates & Maintenance

# Este workflow maneja actualizaciones automÃ¡ticas de dependencias
# y tareas de mantenimiento del repositorio
on:
  schedule:
    # Ejecutar todos los lunes a las 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Tipo de actualizaciÃ³n'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - all

permissions:
  contents: write
  pull-requests: write

jobs:
  # 1. AuditorÃ­a de seguridad
  security-audit:
    name: ğŸ”’ AuditorÃ­a de Seguridad
    runs-on: ubuntu-latest

    outputs:
      vulnerabilities_found: ${{ steps.audit.outputs.vulnerabilities_found }}

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”’ Ejecutar auditorÃ­a de seguridad
        id: audit
        run: |
          echo "Ejecutando auditorÃ­a de seguridad..."

          # AuditorÃ­a con pnpm
          if pnpm audit --fix > audit-results.txt 2>&1; then
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
            echo "âœ… No se encontraron vulnerabilidades"
          else
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Se encontraron vulnerabilidades:"
            cat audit-results.txt
          fi

      - name: ğŸ“¤ Subir resultados de auditorÃ­a
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-results
          path: audit-results.txt

  # 2. Actualizar dependencias de Node.js
  update-node-dependencies:
    name: ğŸ“¦ Actualizar Dependencias Node.js
    runs-on: ubuntu-latest
    needs: security-audit

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“‹ Analizar dependencias actuales
        run: |
          echo "## ğŸ“¦ Dependencias actuales" > dependency-report.md
          echo "" >> dependency-report.md

          pnpm list --depth=0 >> dependency-report.md || true

          echo "" >> dependency-report.md
          echo "## ğŸ” Dependencias desactualizadas" >> dependency-report.md
          pnpm outdated >> dependency-report.md || true

      - name: ğŸ”„ Actualizar dependencias
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"

          echo "Actualizando dependencias: $UPDATE_TYPE"

          case $UPDATE_TYPE in
            patch)
              pnpm update --latest
              ;;
            minor)
              pnpm update --latest --depth=1
              ;;
            major)
              pnpm update --latest --depth=2
              ;;
            all)
              pnpm update --latest --depth=999
              ;;
          esac

      - name: ğŸ§ª Verificar que todo funciona despuÃ©s de actualizar
        run: |
          echo "Verificando instalaciÃ³n..."
          pnpm install

          echo "Ejecutando build..."
          pnpm run build || echo "Build failed, pero continuamos"

          echo "Ejecutando tests bÃ¡sicos..."
          pnpm run test || echo "Tests failed, pero continuamos"

      - name: ğŸ“ Generar resumen de cambios
        run: |
          echo "" >> dependency-report.md
          echo "## ğŸ“ Cambios realizados" >> dependency-report.md
          echo "" >> dependency-report.md

          if git diff --name-only | grep -q package.json; then
            echo "### ğŸ“¦ package.json modificado" >> dependency-report.md
            echo "\`\`\`diff" >> dependency-report.md
            git diff package.json >> dependency-report.md
            echo "\`\`\`" >> dependency-report.md
          fi

          if git diff --name-only | grep -q pnpm-lock.yaml; then
            echo "### ğŸ”’ pnpm-lock.yaml actualizado" >> dependency-report.md
          fi

      - name: ğŸ“¤ Crear Pull Request si hay cambios
        if: github.event_name == 'schedule' || github.event.inputs.update_type
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if git diff --quiet; then
            echo "No hay cambios en las dependencias"
          else
            # Crear rama para el PR
            BRANCH_NAME="auto-update-dependencies-$(date +%Y%m%d)"
            git checkout -b $BRANCH_NAME
            
            git add .
            git commit -m "chore: actualizar dependencias automÃ¡ticamente
            
            - ActualizaciÃ³n de tipo: ${{ github.event.inputs.update_type || 'patch' }}
            - Ejecutado por: GitHub Actions
            - Fecha: $(date)
            
            Cambios incluidos:
            $(git diff --name-only HEAD~1)"
            
            git push origin $BRANCH_NAME
            
            # Crear PR usando gh CLI si estÃ¡ disponible
            echo "Creando Pull Request..."
          fi

      - name: ğŸ“¤ Subir reporte de dependencias
        uses: actions/upload-artifact@v3
        with:
          name: dependency-report
          path: dependency-report.md

  # 3. Actualizar imÃ¡genes de Docker
  update-docker-images:
    name: ğŸ³ Actualizar ImÃ¡genes Docker
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ³ Verificar versiones actuales de imÃ¡genes
        run: |
          echo "## ğŸ³ Versiones actuales de Docker" > docker-versions.md
          echo "" >> docker-versions.md

          # Extraer imÃ¡genes del docker-compose.yml
          grep "image:" docker-compose.yml | while read -r line; do
            image=$(echo "$line" | awk '{print $2}')
            echo "- $image" >> docker-versions.md
          done

      - name: ğŸ” Verificar actualizaciones disponibles
        run: |
          echo "" >> docker-versions.md
          echo "## ğŸ” Verificando actualizaciones..." >> docker-versions.md

          # Pull de las imÃ¡genes para verificar si hay versiones mÃ¡s nuevas
          docker pull node:18-alpine
          docker pull postgres:15-alpine

          echo "âœ… VerificaciÃ³n completada" >> docker-versions.md

      - name: ğŸ“¤ Subir reporte de Docker
        uses: actions/upload-artifact@v3
        with:
          name: docker-versions
          path: docker-versions.md

  # 4. Limpiar workflows antiguos
  cleanup-workflows:
    name: ğŸ§¹ Limpieza de Workflows
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¹ Limpiar workflow runs antiguos
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Obtener workflows
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: owner,
              repo: repo,
            });

            // Para cada workflow, limpiar runs antiguos (mantener solo los Ãºltimos 10)
            for (const workflow of workflows.data.workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: owner,
                repo: repo,
                workflow_id: workflow.id,
                per_page: 100
              });
              
              // Eliminar runs antiguos (mantener solo los Ãºltimos 10)
              const runsToDelete = runs.data.workflow_runs.slice(10);
              
              for (const run of runsToDelete) {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner: owner,
                    repo: repo,
                    run_id: run.id,
                  });
                  console.log(`Eliminado run ${run.id} del workflow ${workflow.name}`);
                } catch (error) {
                  console.log(`No se pudo eliminar run ${run.id}: ${error.message}`);
                }
              }
            }

  # 5. Actualizar documentaciÃ³n automÃ¡tica
  update-docs:
    name: ğŸ“š Actualizar DocumentaciÃ³n AutomÃ¡tica
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Generar estadÃ­sticas del proyecto
        run: |
          echo "# ğŸ“Š EstadÃ­sticas del Proyecto (Actualizado automÃ¡ticamente)" > docs/estadisticas.md
          echo "" >> docs/estadisticas.md
          echo "**Ãšltima actualizaciÃ³n:** $(date)" >> docs/estadisticas.md
          echo "" >> docs/estadisticas.md

          # EstadÃ­sticas de cÃ³digo
          echo "## ğŸ“ CÃ³digo" >> docs/estadisticas.md
          echo "- **LÃ­neas de cÃ³digo TypeScript:** $(find ejemplos -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print $1}')" >> docs/estadisticas.md
          echo "- **LÃ­neas de cÃ³digo JavaScript:** $(find ejemplos -name "*.js" -exec wc -l {} + | tail -1 | awk '{print $1}' 2>/dev/null || echo 0)" >> docs/estadisticas.md
          echo "- **Archivos de configuraciÃ³n:** $(find . -name "*.json" -o -name "*.yml" -o -name "*.yaml" | wc -l)" >> docs/estadisticas.md
          echo "" >> docs/estadisticas.md

          # EstadÃ­sticas de documentaciÃ³n
          echo "## ğŸ“š DocumentaciÃ³n" >> docs/estadisticas.md
          echo "- **Archivos de documentaciÃ³n:** $(find docs -name "*.md" | wc -l)" >> docs/estadisticas.md
          echo "- **Palabras en documentaciÃ³n:** $(find docs -name "*.md" -exec wc -w {} + | tail -1 | awk '{print $1}')" >> docs/estadisticas.md
          echo "" >> docs/estadisticas.md

          # EstadÃ­sticas de ejemplos
          echo "## ğŸ¯ Ejemplos" >> docs/estadisticas.md
          for i in {01..07}; do
            count=$(find ejemplos/modulo-${i} -name "*.ts" -o -name "*.js" 2>/dev/null | wc -l)
            echo "- **MÃ³dulo ${i}:** $count archivos de ejemplo" >> docs/estadisticas.md
          done

      - name: ğŸ“ Commit estadÃ­sticas si hay cambios
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if git diff --quiet docs/estadisticas.md; then
            echo "No hay cambios en las estadÃ­sticas"
          else
            git add docs/estadisticas.md
            git commit -m "docs: actualizar estadÃ­sticas automÃ¡ticamente"
            git push
          fi

  # 6. Resumen de mantenimiento
  maintenance-summary:
    name: ğŸ“‹ Resumen de Mantenimiento
    runs-on: ubuntu-latest
    needs:
      [
        security-audit,
        update-node-dependencies,
        update-docker-images,
        cleanup-workflows,
        update-docs,
      ]
    if: always()

    steps:
      - name: ğŸ“‹ Generar resumen final
        run: |
          echo "## ğŸ”„ Resumen de Mantenimiento AutomÃ¡tico"
          echo ""
          echo "**Fecha:** $(date)"
          echo "**Trigger:** ${{ github.event_name }}"
          echo ""
          echo "| Tarea | Estado |"
          echo "|-------|---------|"
          echo "| AuditorÃ­a de seguridad | ${{ needs.security-audit.result == 'success' && 'âœ…' || 'âŒ' }} |"
          echo "| ActualizaciÃ³n de dependencias | ${{ needs.update-node-dependencies.result == 'success' && 'âœ…' || 'âŒ' }} |"
          echo "| ActualizaciÃ³n de Docker | ${{ needs.update-docker-images.result == 'success' && 'âœ…' || 'âŒ' }} |"
          echo "| Limpieza de workflows | ${{ needs.cleanup-workflows.result == 'success' && 'âœ…' || 'âŒ' }} |"
          echo "| ActualizaciÃ³n de docs | ${{ needs.update-docs.result == 'success' && 'âœ…' || 'âŒ' }} |"
          echo ""

          if [[ "${{ needs.security-audit.outputs.vulnerabilities_found }}" == "true" ]]; then
            echo "âš ï¸  **Se encontraron vulnerabilidades de seguridad. Revisa los artefactos.**"
          else
            echo "ğŸ”’ **No se encontraron vulnerabilidades de seguridad.**"
          fi
